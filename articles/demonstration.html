<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Demonstration of the package usage • fastei</title>
<!-- mathjax math --><script src="https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/tex-mml-chtml.js" integrity="sha256-MASABpB4tYktI2Oitl4t+78w/lyA+D7b/s9GEP0JOGI=" crossorigin="anonymous"></script><script>
  window.MathJax = {
    chtml: {
      fontURL: "https://cdn.jsdelivr.net/npm/mathjax@3.2.2/es5/output/chtml/fonts/woff-v2"
    }
  };
</script><script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Demonstration of the package usage">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">fastei</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.9</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="external-link nav-link" href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=4832834">Paper</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-functions" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Functions</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-functions">
<li><a class="dropdown-item" href="../reference/run_em.html">run_em()</a></li>
    <li><a class="dropdown-item" href="../reference/bootstrap.html">bootstrap()</a></li>
    <li><a class="dropdown-item" href="../reference/simulate_election.html">simulate_election()</a></li>
    <li><a class="dropdown-item" href="../reference/get_agg_opt.html">get_agg_opt()</a></li>
    <li><a class="dropdown-item" href="../reference/get_agg_proxy.html">get_agg_proxy()</a></li>
    <li><a class="dropdown-item" href="../reference/waldtest.html">waldtest()</a></li>
    <li><a class="dropdown-item" href="../reference/get_eim_chile.html">get_eim_chile()</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Index</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/index.html">Articles</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/DanielHermosilla/ecological-inference-elections/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Demonstration of the package usage</h1>
                        <h4 data-toc-skip class="author">Charles
Thraves, Pablo Ubilla, Daniel Hermosilla</h4>
            
            <h4 data-toc-skip class="date">2025-07-25</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/DanielHermosilla/ecological-inference-elections/blob/HEAD/vignettes/demonstration.Rmd" class="external-link"><code>vignettes/demonstration.Rmd</code></a></small>
      <div class="d-none name"><code>demonstration.Rmd</code></div>
    </div>

    
    
<p>The <code>fastei</code> library implements the
Expectation-Maximization algorithm to estimate probabilities in
non-parametric Ecological Inference for the RxC case. It offers both an
exact method and four approximation methods suitable for large datasets.
The application demonstrated here is based on an electoral context
where, for each ballot box, we know the number of voters in each
demographic group and the number of votes received by each
candidate.</p>
<div class="section level2">
<h2 id="estimate-voting-probabilities">Estimate Voting Probabilities<a class="anchor" aria-label="anchor" href="#estimate-voting-probabilities"></a>
</h2>
<p>We use data from the First Round of the Chilean Presidential Election
of 2021, where at each ballot box we have the voters of eight age ranges
(groups), and candidate votes obtained. The function
<code><a href="../reference/get_eim_chile.html">get_eim_chile()</a></code> loads this data at either the country,
region, or electoral district level.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://danielhermosilla.github.io/ecological-inference-elections/reference/fastei-package.html">fastei</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">eim_apo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_eim_chile.html">get_eim_chile</a></span><span class="op">(</span>elect_district <span class="op">=</span> <span class="st">"APOQUINDO"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">eim_apo</span></span></code></pre></div>
<pre><code><span><span class="co">## eim ecological inference model</span></span>
<span><span class="co">## Candidates' vote matrix (X) [b x c]:</span></span>
<span><span class="co">##     C1  C2 C3 C4 C5 C6 C7 C8</span></span>
<span><span class="co">## 37M 36  91 19 48  2  7  2  5</span></span>
<span><span class="co">## 38M 29 103 17 54  1  6  3  3</span></span>
<span><span class="co">## 39M 32  81 13 73  1  5  5  1</span></span>
<span><span class="co">## 40M 25  95 21 38  3  4  2  2</span></span>
<span><span class="co">## 41M 31  86 19 48  0  4  5  2</span></span>
<span><span class="co">## .</span></span>
<span><span class="co">## .</span></span>
<span><span class="co">## .</span></span>
<span><span class="co">## Group-level voter matrix (W) [b x g]:</span></span>
<span><span class="co">##     X18.19 X20.29 X30.39 X40.49 X50.59 X60.69 X70.79 X80.</span></span>
<span><span class="co">## 37M      5     27     11     50     23     39     36   19</span></span>
<span><span class="co">## 38M      5     33     11     48     22     42     36   19</span></span>
<span><span class="co">## 39M      4     19     11     71     29     30     35   11</span></span>
<span><span class="co">## 40M      6     21      6     49     36     20     29   23</span></span>
<span><span class="co">## 41M      3     27      6     55     23     29     33   19</span></span>
<span><span class="co">## .</span></span>
<span><span class="co">## .</span></span>
<span><span class="co">## .</span></span></code></pre>
<p>As shown in the output, it returns an eim object that contains two
matrices: the number of votes per candidate and the number of votes per
group. The rows of both matrices correspond to the specific ballot-box,
and the columns are candidates and groups, respectively. This eim object
is used as input to run the EM algorithm that estimates the voting
probabilities. In this example, it uses the default method
<code>mult</code>, which is the most efficient in terms of runtime.
Running the algorithm is done by calling <code><a href="../reference/run_em.html">run_em()</a></code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">eim_apo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_em.html">run_em</a></span><span class="op">(</span><span class="va">eim_apo</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">eim_apo</span><span class="op">$</span><span class="va">prob</span>, <span class="fl">4</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##            C1     C2     C3     C4     C5     C6     C7     C8</span></span>
<span><span class="co">## X18.19 0.1802 0.3812 0.0859 0.3191 0.0105 0.0187 0.0040 0.0003</span></span>
<span><span class="co">## X20.29 0.2022 0.3427 0.0492 0.3472 0.0086 0.0163 0.0188 0.0149</span></span>
<span><span class="co">## X30.39 0.1621 0.4130 0.0418 0.3493 0.0030 0.0081 0.0188 0.0039</span></span>
<span><span class="co">## X40.49 0.0919 0.4898 0.0786 0.3271 0.0021 0.0041 0.0029 0.0034</span></span>
<span><span class="co">## X50.59 0.1486 0.4141 0.0939 0.2893 0.0011 0.0345 0.0150 0.0035</span></span>
<span><span class="co">## X60.69 0.1007 0.4989 0.0907 0.2744 0.0018 0.0218 0.0071 0.0045</span></span>
<span><span class="co">## X70.79 0.1051 0.5208 0.0844 0.2355 0.0060 0.0219 0.0172 0.0093</span></span>
<span><span class="co">## X80.   0.0759 0.5152 0.1341 0.2169 0.0061 0.0314 0.0118 0.0086</span></span></code></pre>
<p>Note that each row corresponds to the probability that a demographic
group (<code>g</code>) voted for a candidate (<code>c</code>). It is
worth noting how the estimated probabilities differ substantially across
groups.</p>
</div>
<div class="section level2">
<h2 id="standard-deviation-estimates">Standard deviation estimates<a class="anchor" aria-label="anchor" href="#standard-deviation-estimates"></a>
</h2>
<p>We can compute the standard deviation of the estimated probabilities
using bootstrapping. This can be done with the function
<code><a href="../reference/bootstrap.html">bootstrap()</a></code>.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">eim_apo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bootstrap.html">bootstrap</a></span><span class="op">(</span><span class="va">eim_apo</span>, seed <span class="op">=</span> <span class="fl">42</span>, nboot <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">eim_apo</span><span class="op">$</span><span class="va">sd</span>, <span class="fl">4</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##            C1     C2     C3     C4     C5     C6     C7     C8</span></span>
<span><span class="co">## X18.19 0.0292 0.0688 0.0087 0.0404 0.0043 0.0062 0.0059 0.0018</span></span>
<span><span class="co">## X20.29 0.0091 0.0113 0.0042 0.0073 0.0013 0.0037 0.0029 0.0013</span></span>
<span><span class="co">## X30.39 0.0097 0.0113 0.0051 0.0126 0.0010 0.0020 0.0033 0.0014</span></span>
<span><span class="co">## X40.49 0.0077 0.0134 0.0078 0.0094 0.0013 0.0018 0.0017 0.0017</span></span>
<span><span class="co">## X50.59 0.0115 0.0215 0.0091 0.0173 0.0008 0.0066 0.0049 0.0012</span></span>
<span><span class="co">## X60.69 0.0105 0.0199 0.0103 0.0146 0.0010 0.0046 0.0031 0.0020</span></span>
<span><span class="co">## X70.79 0.0125 0.0220 0.0099 0.0171 0.0029 0.0058 0.0060 0.0037</span></span>
<span><span class="co">## X80.   0.0178 0.0310 0.0187 0.0248 0.0041 0.0070 0.0047 0.0036</span></span></code></pre>
<p>The standard deviations obtained in the district “Apoquindo” are low
in general. One reason for this is the high number of ballot boxes in
this district. In contrast, standard deviations of estimated
probabilities in districts with fewer ballot boxes, such as “Navidad”,
are larger.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">eim_nav</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_eim_chile.html">get_eim_chile</a></span><span class="op">(</span>elect_district <span class="op">=</span> <span class="st">"NAVIDAD"</span><span class="op">)</span></span>
<span><span class="va">eim_nav</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bootstrap.html">bootstrap</a></span><span class="op">(</span><span class="va">eim_nav</span>, seed <span class="op">=</span> <span class="fl">42</span>, nboot <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">eim_nav</span><span class="op">$</span><span class="va">sd</span>, <span class="fl">4</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##            C1     C2     C3     C4     C5     C6     C7     C8</span></span>
<span><span class="co">## X18.19 0.1092 0.2340 0.0002 0.3233 0.1278 0.0955 0.2173 0.0859</span></span>
<span><span class="co">## X20.29 0.1556 0.0754 0.0612 0.1184 0.0344 0.0009 0.1017 0.0056</span></span>
<span><span class="co">## X30.39 0.0896 0.0708 0.0597 0.0816 0.0209 0.0333 0.0409 0.0040</span></span>
<span><span class="co">## X40.49 0.0904 0.1111 0.0462 0.0629 0.0098 0.0521 0.0272 0.0072</span></span>
<span><span class="co">## X50.59 0.0815 0.0816 0.0812 0.0795 0.0013 0.0328 0.0158 0.0255</span></span>
<span><span class="co">## X60.69 0.1047 0.1017 0.1196 0.0768 0.0152 0.0794 0.0199 0.0010</span></span>
<span><span class="co">## X70.79 0.1534 0.1398 0.1374 0.0815 0.0242 0.0447 0.0364 0.0001</span></span>
<span><span class="co">## X80.   0.1526 0.0842 0.2060 0.0635 0.1175 0.2250 0.2422 0.1073</span></span></code></pre>
<p>It is possible to see the difference in a visual way by plotting the
standard deviations of the estimated probabilities across groups.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/hadley/reshape" class="external-link">reshape2</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://sjmgarnier.github.io/viridis/" class="external-link">viridis</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">plot_district</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">matrix1</span>, <span class="va">district1</span>, <span class="va">matrix2</span>, <span class="va">district2</span>, <span class="va">sd</span> <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="va">value</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">sd</span> <span class="op">==</span> <span class="cn">FALSE</span>, <span class="st">"prob"</span>, <span class="st">"sd"</span><span class="op">)</span></span>
<span>    <span class="va">df1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html" class="external-link">melt</a></span><span class="op">(</span><span class="va">matrix1</span><span class="op">)</span></span>
<span>    <span class="va">df2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html" class="external-link">melt</a></span><span class="op">(</span><span class="va">matrix2</span><span class="op">)</span></span>
<span>    <span class="va">df1</span><span class="op">$</span><span class="va">Matrix</span> <span class="op">&lt;-</span> <span class="va">district1</span></span>
<span>    <span class="va">df2</span><span class="op">$</span><span class="va">Matrix</span> <span class="op">&lt;-</span> <span class="va">district2</span></span>
<span>    <span class="va">combined_df</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">df1</span>, <span class="va">df2</span><span class="op">)</span></span>
<span>    <span class="va">color</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">value</span> <span class="op">==</span> <span class="st">"prob"</span>, <span class="st">"plasma"</span>, <span class="st">"viridis"</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Add text to each cell of the matrix</span></span>
<span>    <span class="va">combined_df</span><span class="op">$</span><span class="va">label</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%.3f"</span>, <span class="va">combined_df</span><span class="op">$</span><span class="va">value</span><span class="op">)</span></span>
<span>    <span class="va">combined_df</span><span class="op">$</span><span class="va">text_color</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">combined_df</span><span class="op">$</span><span class="va">value</span> <span class="op">&gt;</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">combined_df</span><span class="op">$</span><span class="va">value</span><span class="op">)</span> <span class="op">*</span> <span class="fl">0.75</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">min</a></span><span class="op">(</span><span class="va">combined_df</span><span class="op">$</span><span class="va">value</span><span class="op">)</span> <span class="op">*</span> <span class="fl">0.25</span>, <span class="fl">2</span><span class="op">)</span>, <span class="st">"black"</span>, <span class="st">"white"</span><span class="op">)</span></span>
<span>    <span class="va">districts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">district1</span>, <span class="va">district2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># Call the plot</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">combined_df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Var2</span>, y <span class="op">=</span> <span class="va">Var1</span>, fill <span class="op">=</span> <span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_tile</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html" class="external-link">geom_text</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>label <span class="op">=</span> <span class="va">label</span>, color <span class="op">=</span> <span class="va">text_color</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">2.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://sjmgarnier.github.io/viridis/reference/scale_viridis.html" class="external-link">scale_fill_viridis</a></span><span class="op">(</span></span>
<span>            name <span class="op">=</span> <span class="va">value</span>,</span>
<span>            option <span class="op">=</span> <span class="va">color</span>,</span>
<span>        <span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_identity.html" class="external-link">scale_color_identity</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">Matrix</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_fixed</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>            title <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">value</span> <span class="op">==</span> <span class="st">"prob"</span>,</span>
<span>                <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Estimated probabilities in districts:"</span>, <span class="va">districts</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="st">"and"</span>, <span class="va">districts</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span>,</span>
<span>                <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste</a></span><span class="op">(</span><span class="st">"Standard deviation of estimated probabilities in districts:"</span>, <span class="va">districts</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span>, <span class="st">"and"</span>, <span class="va">districts</span><span class="op">[</span><span class="fl">2</span><span class="op">]</span><span class="op">)</span></span>
<span>            <span class="op">)</span>,</span>
<span>            x <span class="op">=</span> <span class="st">"Candidates' votes"</span>, y <span class="op">=</span> <span class="st">"Voters' age range"</span>, fill <span class="op">=</span> <span class="va">value</span></span>
<span>        <span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plot_district</span><span class="op">(</span></span>
<span>    matrix1 <span class="op">=</span> <span class="va">eim_nav</span><span class="op">$</span><span class="va">sd</span>, district1 <span class="op">=</span> <span class="st">"Navidad"</span>,</span>
<span>    matrix2 <span class="op">=</span> <span class="va">eim_apo</span><span class="op">$</span><span class="va">sd</span>, district2 <span class="op">=</span> <span class="st">"Apoquindo"</span>, sd <span class="op">=</span> <span class="cn">TRUE</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="demonstration_files/figure-html/navidad_apoq_sd_comparison-1.png" alt="Navidad and Apoquindo standard deviation comparison" width="768"><p class="caption">
Navidad and Apoquindo standard deviation comparison
</p>
</div>
</div>
<div class="section level2">
<h2 id="reduce-estimation-error-using-group-aggregation">Reduce Estimation Error using Group Aggregation<a class="anchor" aria-label="anchor" href="#reduce-estimation-error-using-group-aggregation"></a>
</h2>
<p>Demographic groups can be merged to have probability estimates with
lower error. A greedy strategy that maximizes the variability of the
distribution of groups across ballot boxes is used, which ensures
standard deviations are below a specific threshold. The package provides
the following function for the latter:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">eim_nav_proxy</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_agg_proxy.html">get_agg_proxy</a></span><span class="op">(</span><span class="va">eim_nav</span>, seed <span class="op">=</span> <span class="fl">6</span>, sd_threshold <span class="op">=</span> <span class="fl">0.03</span>, sd_statistic <span class="op">=</span> <span class="st">"maximum"</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## Matrix (2x8):</span></span>
<span><span class="co">## | 0.011  0.011   0.015   0.011   0.003   0.006   0.005   0.003 |</span></span>
<span><span class="co">## | 0.010  0.015   0.019   0.007   0.003   0.006   0.005   0.002 |</span></span></code></pre>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">eim_nav_proxy</span><span class="op">$</span><span class="va">group_agg</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 4 8</span></span></code></pre>
<p>As shown in the output, the heuristic finds a group aggregation that
merges the first and last four age ranges, namely, macro-groups with
voters aged 18-49, and older than 50. We can evaluate the effectiveness
of this grouping by comparing the mean standard deviation to the
original formulation:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">eim_nav</span><span class="op">$</span><span class="va">sd</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">eim_nav_proxy</span><span class="op">$</span><span class="va">sd</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.07432595</span></span></code></pre>
<p>It is possible to see the aggregated standard deviations
visually:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">plot_matrix</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">mat</span>, <span class="va">sd</span> <span class="op">=</span> <span class="cn">FALSE</span>, <span class="va">y_labels</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span></span>
<span>    <span class="co"># Initial configurations</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">sd</span><span class="op">)</span> <span class="va">mat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span></span>
<span>    <span class="va">df</span> <span class="op">&lt;-</span> <span class="fu">reshape2</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/reshape2/man/melt.html" class="external-link">melt</a></span><span class="op">(</span><span class="va">mat</span><span class="op">)</span></span>
<span>    <span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">colnames</a></span><span class="op">(</span><span class="va">df</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"Row"</span>, <span class="st">"Column"</span>, <span class="st">"Value"</span><span class="op">)</span></span>
<span>    <span class="va">df</span><span class="op">$</span><span class="va">Row</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">Row</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rev.html" class="external-link">rev</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">Row</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">df</span><span class="op">$</span><span class="va">Column</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">Column</span>, levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">Column</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">sd</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">df</span><span class="op">$</span><span class="va">Label</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%d"</span>, <span class="va">df</span><span class="op">$</span><span class="va">Value</span><span class="op">)</span></span>
<span>        <span class="va">title_text</span> <span class="op">&lt;-</span> <span class="st">"Voters distribution"</span></span>
<span>        <span class="va">x_lab</span> <span class="op">&lt;-</span> <span class="st">"Ballot Box"</span></span>
<span>        <span class="va">y_lab</span> <span class="op">&lt;-</span> <span class="st">"Dem. Group"</span></span>
<span>        <span class="va">fill_lab</span> <span class="op">&lt;-</span> <span class="st">"Voters"</span></span>
<span>        <span class="va">df</span><span class="op">$</span><span class="va">text_color</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">Value</span> <span class="op">&gt;</span> <span class="fl">30</span>, <span class="st">"black"</span>, <span class="st">"white"</span><span class="op">)</span></span>
<span>        <span class="va">option</span> <span class="op">&lt;-</span> <span class="st">"inferno"</span></span>
<span>        <span class="va">start</span> <span class="op">&lt;-</span> <span class="fl">0.5</span></span>
<span>        <span class="va">limits</span> <span class="op">&lt;-</span> <span class="cn">NULL</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>        <span class="va">df</span><span class="op">$</span><span class="va">Label</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sprintf.html" class="external-link">sprintf</a></span><span class="op">(</span><span class="st">"%.3f"</span>, <span class="va">df</span><span class="op">$</span><span class="va">Value</span><span class="op">)</span></span>
<span>        <span class="va">title_text</span> <span class="op">&lt;-</span> <span class="st">"Standard deviation of estimated probabilities on district: Navidad"</span></span>
<span>        <span class="va">x_lab</span> <span class="op">&lt;-</span> <span class="st">"Candidates' votes"</span></span>
<span>        <span class="va">y_lab</span> <span class="op">&lt;-</span> <span class="st">"Voters' age range"</span></span>
<span>        <span class="va">fill_lab</span> <span class="op">&lt;-</span> <span class="st">"sd"</span></span>
<span>        <span class="va">df</span><span class="op">$</span><span class="va">text_color</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">df</span><span class="op">$</span><span class="va">Value</span> <span class="op">&gt;</span> <span class="fl">0.13</span>, <span class="st">"black"</span>, <span class="st">"white"</span><span class="op">)</span></span>
<span>        <span class="va">option</span> <span class="op">&lt;-</span> <span class="st">"viridis"</span></span>
<span>        <span class="va">start</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>        <span class="va">limits</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">0.1</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span></span>
<span>    <span class="co"># Plot</span></span>
<span>    <span class="va">p</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">df</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">Column</span>, y <span class="op">=</span> <span class="va">Row</span>, fill <span class="op">=</span> <span class="va">Value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_tile.html" class="external-link">geom_tile</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_text.html" class="external-link">geom_text</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>label <span class="op">=</span> <span class="va">Label</span>, color <span class="op">=</span> <span class="va">text_color</span><span class="op">)</span>, size <span class="op">=</span> <span class="fl">3</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_identity.html" class="external-link">scale_color_identity</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html" class="external-link">scale_fill_viridis_c</a></span><span class="op">(</span>option <span class="op">=</span> <span class="va">option</span>, begin <span class="op">=</span> <span class="va">start</span>, limits <span class="op">=</span> <span class="va">limits</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/coord_fixed.html" class="external-link">coord_fixed</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>axis.text.y <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">7</span><span class="op">)</span>, axis.text.x <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_text</a></span><span class="op">(</span>size <span class="op">=</span> <span class="fl">7</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>        <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">labs</a></span><span class="op">(</span></span>
<span>            title <span class="op">=</span> <span class="va">title_text</span>,</span>
<span>            x <span class="op">=</span> <span class="va">x_lab</span>,</span>
<span>            y <span class="op">=</span> <span class="va">y_lab</span>,</span>
<span>            fill <span class="op">=</span> <span class="va">fill_lab</span></span>
<span>        <span class="op">)</span></span>
<span>    <span class="co"># Add custom y-axis labels if provided</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NULL.html" class="external-link">is.null</a></span><span class="op">(</span><span class="va">y_labels</span><span class="op">)</span><span class="op">)</span> <span class="op">{</span></span>
<span>        <span class="va">p</span> <span class="op">&lt;-</span> <span class="va">p</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_discrete.html" class="external-link">scale_y_discrete</a></span><span class="op">(</span>labels <span class="op">=</span> <span class="va">y_labels</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="va">p</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>We can visualize the standard deviations of the estimated
probabilities.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plot_matrix</span><span class="op">(</span><span class="va">eim_nav_proxy</span><span class="op">$</span><span class="va">sd</span>, sd <span class="op">=</span> <span class="cn">TRUE</span>, y_labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X18.49"</span>, <span class="st">"X50."</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="demonstration_files/figure-html/standard_deviation_proxy-1.png" alt="Navidad aggregated standard deviation with proxy method" width="768"><p class="caption">
Navidad aggregated standard deviation with proxy method
</p>
</div>
<p>An exhaustive algorithm is also included in the package. It explores
all combinations of adjacent groups in order to maximize the
log-likelihood subject to having standard deviations below a given
threshold. It might require substantial computation time; therefore it
is recommended to use the default method, “mult”.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">eim_nav_opt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_agg_opt.html">get_agg_opt</a></span><span class="op">(</span><span class="va">eim_nav</span>, seed <span class="op">=</span> <span class="fl">0</span>, sd_threshold <span class="op">=</span> <span class="fl">0.03</span>, sd_statistic <span class="op">=</span> <span class="st">"maximum"</span><span class="op">)</span></span>
<span><span class="va">eim_nav_opt</span><span class="op">$</span><span class="va">group_agg</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 2 4 8</span></span></code></pre>
<p>The optimal group aggregation differs slightly from one obtained
before. In this case, the group aggregation consists in the three age
range: 18-29, 30-49, and older than 70.</p>
<p>We can visualize the standard deviations of the estimated
probabilities.</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plot_matrix</span><span class="op">(</span><span class="va">eim_nav_opt</span><span class="op">$</span><span class="va">sd</span>, sd <span class="op">=</span> <span class="cn">TRUE</span>, y_labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"X18.29"</span>, <span class="st">"X30.49"</span>, <span class="st">"X50."</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="demonstration_files/figure-html/standard_deviation_opt-1.png" alt="Navidad aggregated standard deviation with opt method" width="768"><p class="caption">
Navidad aggregated standard deviation with opt method
</p>
</div>
</div>
<div class="section level2">
<h2 id="test-difference-between-estimates">Test difference between estimates<a class="anchor" aria-label="anchor" href="#test-difference-between-estimates"></a>
</h2>
<p>A relevant question is how significantly different are the
probability estimates of two sets of data, such as two different
districts. For instance, we can compare the estimated probabilities of
the district “LO BARNECHEA” and “LA GRANJA”, whose voting tendencies are
expected to differ.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">eim_gra</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_eim_chile.html">get_eim_chile</a></span><span class="op">(</span><span class="st">"LA GRANJA"</span><span class="op">)</span></span>
<span><span class="va">eim_gra</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_em.html">run_em</a></span><span class="op">(</span><span class="va">eim_gra</span><span class="op">)</span></span>
<span><span class="va">eim_bar</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_eim_chile.html">get_eim_chile</a></span><span class="op">(</span><span class="st">"LO BARNECHEA"</span><span class="op">)</span></span>
<span><span class="va">eim_bar</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_em.html">run_em</a></span><span class="op">(</span><span class="va">eim_bar</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">plot_district</span><span class="op">(</span><span class="va">eim_gra</span><span class="op">$</span><span class="va">prob</span>, <span class="st">"La Granja"</span>, <span class="va">eim_bar</span><span class="op">$</span><span class="va">prob</span>, <span class="st">"Lo Barnechea"</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="demonstration_files/figure-html/granja_lobarnechea_comparison-1.png" alt="Lo Barnechea and La Granja comparison" width="768"><p class="caption">
Lo Barnechea and La Granja comparison
</p>
</div>
<p>A Wald test can be applied to each component of the two probability
matrix estimates:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">comparison2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/waldtest.html">waldtest</a></span><span class="op">(</span></span>
<span>    object1 <span class="op">=</span> <span class="va">eim_gra</span>,</span>
<span>    object2 <span class="op">=</span> <span class="va">eim_bar</span>,</span>
<span>    method <span class="op">=</span> <span class="st">"mult"</span>,</span>
<span>    nboot <span class="op">=</span> <span class="fl">30</span>,</span>
<span>    seed <span class="op">=</span> <span class="fl">42</span>,</span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">comparison2</span><span class="op">$</span><span class="va">pvals</span>, <span class="fl">3</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##           C1    C2    C3    C4    C5    C6    C7    C8</span></span>
<span><span class="co">## X18.19 0.000 0.000 0.208 0.000 0.533 0.033 0.443 0.878</span></span>
<span><span class="co">## X20.29 0.000 0.000 0.005 0.000 0.000 0.000 0.000 0.823</span></span>
<span><span class="co">## X30.39 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.009</span></span>
<span><span class="co">## X40.49 0.000 0.000 0.000 0.000 0.000 0.000 0.000 0.000</span></span>
<span><span class="co">## X50.59 0.000 0.000 0.000 0.000 0.182 0.000 0.000 0.180</span></span>
<span><span class="co">## X60.69 0.000 0.000 0.001 0.000 0.069 0.000 0.633 0.426</span></span>
<span><span class="co">## X70.79 0.748 0.003 0.000 0.714 0.456 0.923 0.015 0.542</span></span>
<span><span class="co">## X80.   0.992 0.154 0.071 0.747 0.978 0.336 0.326 0.370</span></span></code></pre>
<p>Conversely, one may examine the alternative scenario in which ballot
boxes within a given region are partitioned into equally sized groups.
In this configuration, both groups are expected to exhibit identical
probability distributions.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">eimRM</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_eim_chile.html">get_eim_chile</a></span><span class="op">(</span>region <span class="op">=</span> <span class="st">"METROPOLITANA DE SANTIAGO"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">eimRM</span><span class="op">$</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="va">n_train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">floor</a></span><span class="op">(</span><span class="va">n</span> <span class="op">*</span> <span class="fl">0.5</span><span class="op">)</span></span>
<span><span class="va">train_indices</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span>, <span class="va">n_train</span><span class="op">)</span></span>
<span></span>
<span><span class="va">eimRMhalf1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/eim.html">eim</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">eimRM</span><span class="op">$</span><span class="va">X</span><span class="op">[</span><span class="va">train_indices</span>, <span class="op">]</span>, W <span class="op">=</span> <span class="va">eimRM</span><span class="op">$</span><span class="va">W</span><span class="op">[</span><span class="va">train_indices</span>, <span class="op">]</span><span class="op">)</span></span>
<span><span class="va">eimRMhalf2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/eim.html">eim</a></span><span class="op">(</span>X <span class="op">=</span> <span class="va">eimRM</span><span class="op">$</span><span class="va">X</span><span class="op">[</span><span class="op">-</span><span class="va">train_indices</span>, <span class="op">]</span>, W <span class="op">=</span> <span class="va">eimRM</span><span class="op">$</span><span class="va">W</span><span class="op">[</span><span class="op">-</span><span class="va">train_indices</span>, <span class="op">]</span><span class="op">)</span></span>
<span></span>
<span><span class="va">eimRMhalf1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_em.html">run_em</a></span><span class="op">(</span><span class="va">eimRMhalf1</span><span class="op">)</span></span>
<span><span class="va">eimRMhalf2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_em.html">run_em</a></span><span class="op">(</span><span class="va">eimRMhalf2</span><span class="op">)</span></span>
<span></span>
<span><span class="fu">plot_district</span><span class="op">(</span><span class="va">eimRMhalf1</span><span class="op">$</span><span class="va">prob</span>, <span class="st">"Half 1"</span>, <span class="va">eimRMhalf2</span><span class="op">$</span><span class="va">prob</span>, <span class="st">"Half 2"</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="demonstration_files/figure-html/half_comparison-1.png" alt="Equally sorted districts comparison" width="768"><p class="caption">
Equally sorted districts comparison
</p>
</div>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">comparison2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/waldtest.html">waldtest</a></span><span class="op">(</span></span>
<span>    object1 <span class="op">=</span> <span class="va">eimRMhalf1</span>,</span>
<span>    object2 <span class="op">=</span> <span class="va">eimRMhalf2</span>,</span>
<span>    nboot <span class="op">=</span> <span class="fl">10</span>,</span>
<span>    seed <span class="op">=</span> <span class="fl">42</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Round.html" class="external-link">round</a></span><span class="op">(</span><span class="va">comparison2</span><span class="op">$</span><span class="va">pvals</span>, <span class="fl">4</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">##            C1     C2     C3     C4     C5     C6     C7     C8</span></span>
<span><span class="co">## X18.19 0.1052 0.1768 0.9525 0.0459 0.0615 0.5609 0.3218 0.3814</span></span>
<span><span class="co">## X20.29 0.0240 0.0584 0.1939 0.1279 0.3934 0.2638 0.8407 0.0418</span></span>
<span><span class="co">## X30.39 0.0173 0.0695 0.8241 0.6153 0.9132 0.9874 0.9704 0.5675</span></span>
<span><span class="co">## X40.49 0.9661 0.7262 0.7254 0.0750 0.0199 0.0098 0.3868 0.2005</span></span>
<span><span class="co">## X50.59 0.7181 0.4912 0.4623 0.5796 0.6915 0.9020 0.4608 0.6597</span></span>
<span><span class="co">## X60.69 0.0684 0.0034 0.6953 0.7221 0.8145 0.5284 0.2461 0.0607</span></span>
<span><span class="co">## X70.79 0.9179 0.7549 0.8788 0.4923 0.2300 0.3565 0.7537 0.0595</span></span>
<span><span class="co">## X80.   0.9998 0.6619 0.4891 0.6027 0.8372 0.9438 0.8549 0.1317</span></span></code></pre>
</div>
<div class="section level2">
<h2 id="simulating-election-results">Simulating Election Results<a class="anchor" aria-label="anchor" href="#simulating-election-results"></a>
</h2>
<p>It is possible to simulate an artificial election and get its values
as an eim object with the simulated probability. This is useful for
testing the package’s performance and comparing the different methods
available.</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">eim_sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate_election.html">simulate_election</a></span><span class="op">(</span>num_ballots <span class="op">=</span> <span class="fl">15</span>, num_groups <span class="op">=</span> <span class="fl">2</span>, num_candidates <span class="op">=</span> <span class="fl">3</span>, seed <span class="op">=</span> <span class="fl">42</span><span class="op">)</span></span>
<span><span class="va">eim_sim</span></span></code></pre></div>
<pre><code><span><span class="co">## eim ecological inference model</span></span>
<span><span class="co">## Candidates' vote matrix (X) [b x c]:</span></span>
<span><span class="co">##      [,1] [,2] [,3]</span></span>
<span><span class="co">## [1,]   23   31   46</span></span>
<span><span class="co">## [2,]   22   35   43</span></span>
<span><span class="co">## [3,]   30   20   50</span></span>
<span><span class="co">## [4,]   24   35   41</span></span>
<span><span class="co">## [5,]   24   29   47</span></span>
<span><span class="co">## .</span></span>
<span><span class="co">## .</span></span>
<span><span class="co">## .</span></span>
<span><span class="co">## Group-level voter matrix (W) [b x g]:</span></span>
<span><span class="co">##      [,1] [,2]</span></span>
<span><span class="co">## [1,]   75   25</span></span>
<span><span class="co">## [2,]   77   23</span></span>
<span><span class="co">## [3,]   73   27</span></span>
<span><span class="co">## [4,]   80   20</span></span>
<span><span class="co">## [5,]   73   27</span></span>
<span><span class="co">## .</span></span>
<span><span class="co">## .</span></span>
<span><span class="co">## .</span></span></code></pre>
<p>The real voting probabilities of each group for each candidate can be
obtained as follows:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">eim_sim</span><span class="op">$</span><span class="va">real_prob</span></span></code></pre></div>
<pre><code><span><span class="co">##           [,1]      [,2]      [,3]</span></span>
<span><span class="co">## [1,] 0.2588692 0.3615164 0.3796145</span></span>
<span><span class="co">## [2,] 0.2913730 0.1829977 0.5256293</span></span></code></pre>
<p>In this case, we can access these values since this is a simulation;
however, this is not possible when working with real data.</p>
<p>The estimated voting probabilities are:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">eim_sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_em.html">run_em</a></span><span class="op">(</span><span class="va">eim_sim</span><span class="op">)</span></span>
<span><span class="va">eim_sim</span><span class="op">$</span><span class="va">prob</span></span></code></pre></div>
<pre><code><span><span class="co">##           [,1]      [,2]      [,3]</span></span>
<span><span class="co">## [1,] 0.2398303 0.3292528 0.4309169</span></span>
<span><span class="co">## [2,] 0.3014838 0.1827996 0.5157166</span></span></code></pre>
<p>It is possible to provide a specific voting probability for each
candidate for each group.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">input_probability</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.9</span>, <span class="fl">0.05</span>, <span class="fl">0.05</span>, <span class="fl">0.2</span>, <span class="fl">0.3</span>, <span class="fl">0.5</span><span class="op">)</span>, nrow <span class="op">=</span> <span class="fl">2</span>, byrow <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="va">input_probability</span></span></code></pre></div>
<pre><code><span><span class="co">##      [,1] [,2] [,3]</span></span>
<span><span class="co">## [1,]  0.9 0.05 0.05</span></span>
<span><span class="co">## [2,]  0.2 0.30 0.50</span></span></code></pre>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">eim_sim2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate_election.html">simulate_election</a></span><span class="op">(</span></span>
<span>    num_ballots <span class="op">=</span> <span class="fl">30</span>, num_groups <span class="op">=</span> <span class="fl">2</span>, num_candidates <span class="op">=</span> <span class="fl">3</span>, seed <span class="op">=</span> <span class="fl">42</span>,</span>
<span>    prob <span class="op">=</span> <span class="va">input_probability</span></span>
<span><span class="op">)</span></span>
<span><span class="va">eim_sim2</span></span></code></pre></div>
<pre><code><span><span class="co">## eim ecological inference model</span></span>
<span><span class="co">## Candidates' vote matrix (X) [b x c]:</span></span>
<span><span class="co">##      [,1] [,2] [,3]</span></span>
<span><span class="co">## [1,]   69   14   17</span></span>
<span><span class="co">## [2,]   75   12   13</span></span>
<span><span class="co">## [3,]   68   10   22</span></span>
<span><span class="co">## [4,]   64   16   20</span></span>
<span><span class="co">## [5,]   72   12   16</span></span>
<span><span class="co">## .</span></span>
<span><span class="co">## .</span></span>
<span><span class="co">## .</span></span>
<span><span class="co">## Group-level voter matrix (W) [b x g]:</span></span>
<span><span class="co">##      [,1] [,2]</span></span>
<span><span class="co">## [1,]   79   21</span></span>
<span><span class="co">## [2,]   78   22</span></span>
<span><span class="co">## [3,]   73   27</span></span>
<span><span class="co">## [4,]   70   30</span></span>
<span><span class="co">## [5,]   73   27</span></span>
<span><span class="co">## .</span></span>
<span><span class="co">## .</span></span>
<span><span class="co">## .</span></span></code></pre>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">eim_sim2</span><span class="op">$</span><span class="va">real_prob</span></span></code></pre></div>
<pre><code><span><span class="co">##      [,1] [,2] [,3]</span></span>
<span><span class="co">## [1,]  0.9 0.05 0.05</span></span>
<span><span class="co">## [2,]  0.2 0.30 0.50</span></span></code></pre>
<p>There is a parameter, lambda, that controls for the heterogeneity of
voters’ groups across ballot boxes. A value of lambda = 0 indicates that
voters are all randomly assigned in ballot boxes; in contrast to lambda
= 1, in which case voters are assigned in ballot boxes according to
their demographic group. This is explained in detail in the
documentation in <code><a href="../reference/simulate_election.html">simulate_election()</a></code>.</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">eim_sim3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate_election.html">simulate_election</a></span><span class="op">(</span></span>
<span>    num_ballots <span class="op">=</span> <span class="fl">20</span>, num_groups <span class="op">=</span> <span class="fl">4</span>, num_candidates <span class="op">=</span> <span class="fl">2</span>, seed <span class="op">=</span> <span class="fl">42</span>,</span>
<span>    lambda <span class="op">=</span> <span class="fl">0.1</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plot_matrix</span><span class="op">(</span><span class="va">eim_sim3</span><span class="op">$</span><span class="va">W</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="demonstration_files/figure-html/eim_sim3_heatmap-1.png" alt="Voters' heatmap for a low lambda value" width="768"><p class="caption">
Voters’ heatmap for a low lambda value
</p>
</div>
<p>Having the following estimated probabilities:</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/run_em.html">run_em</a></span><span class="op">(</span><span class="va">eim_sim3</span><span class="op">)</span><span class="op">$</span><span class="va">prob</span></span></code></pre></div>
<pre><code><span><span class="co">##           [,1]      [,2]</span></span>
<span><span class="co">## [1,] 0.3686854 0.6313146</span></span>
<span><span class="co">## [2,] 0.6627212 0.3372788</span></span>
<span><span class="co">## [3,] 0.2112870 0.7887130</span></span>
<span><span class="co">## [4,] 0.1805033 0.8194967</span></span></code></pre>
<p>On the other side, it is possible to simulate an heterogeneous
sample</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">eim_sim4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate_election.html">simulate_election</a></span><span class="op">(</span></span>
<span>    num_ballots <span class="op">=</span> <span class="fl">20</span>, num_groups <span class="op">=</span> <span class="fl">4</span>, num_candidates <span class="op">=</span> <span class="fl">2</span>, seed <span class="op">=</span> <span class="fl">42</span>,</span>
<span>    lambda <span class="op">=</span> <span class="fl">0.9</span></span>
<span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">plot_matrix</span><span class="op">(</span><span class="va">eim_sim4</span><span class="op">$</span><span class="va">W</span><span class="op">)</span></span></code></pre></div>
<div class="figure" style="text-align: center">
<img src="demonstration_files/figure-html/eim_sim4_heatmap-1.png" alt="Voters' heatmap for a high lambda value" width="768"><p class="caption">
Voters’ heatmap for a high lambda value
</p>
</div>
<p>With the underlying probabilities</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/run_em.html">run_em</a></span><span class="op">(</span><span class="va">eim_sim4</span><span class="op">)</span><span class="op">$</span><span class="va">prob</span></span></code></pre></div>
<pre><code><span><span class="co">##           [,1]      [,2]</span></span>
<span><span class="co">## [1,] 0.3731878 0.6268122</span></span>
<span><span class="co">## [2,] 0.5431853 0.4568147</span></span>
<span><span class="co">## [3,] 0.9365629 0.0634371</span></span>
<span><span class="co">## [4,] 0.8711210 0.1288790</span></span></code></pre>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>fastei</p>
</div>

<div class="pkgdown-footer-right">
  <p>Developed by Charles Thraves, Pablo Ubilla, Daniel Hermosilla.</p>
</div>

    </footer>
</div>





  </body>
</html>
