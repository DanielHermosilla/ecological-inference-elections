<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Demonstration of the package usage • fastei</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.5.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.5.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><script src="../deps/MathJax-3.2.2/tex-chtml.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Demonstration of the package usage">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-primary" data-bs-theme="dark" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">fastei</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">0.0.0.1</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="external-link nav-link" href="https://papers.ssrn.com/sol3/papers.cfm?abstract_id=4832834">Paper</a></li>
<li class="nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-functions" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Functions</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-functions">
<li><a class="dropdown-item" href="../reference/run_em.html">run_em()</a></li>
    <li><a class="dropdown-item" href="../reference/bootstrap.html">bootstrap()</a></li>
    <li><a class="dropdown-item" href="../reference/simulate_election.html">simulate_election()</a></li>
    <li><a class="dropdown-item" href="../reference/get_agg_opt.html">get_agg_opt()</a></li>
    <li><a class="dropdown-item" href="../reference/get_agg_proxy.html">get_agg_proxy()</a></li>
    <li><a class="dropdown-item" href="../reference/welchtest.html">welchtest()</a></li>
    <li><a class="dropdown-item" href="../reference/get_XW_chile.html">get_XW_chile()</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Index</a></li>
<li class="nav-item"><a class="nav-link" href="../articles/index.html">Articles</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/DanielHermosilla/ecological-inference-elections/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Demonstration of the package usage</h1>
                        <h4 data-toc-skip class="author">Daniel
Hermosilla</h4>
            
            <h4 data-toc-skip class="date">2025-04-25</h4>
      
      <small class="dont-index">Source: <a href="https://github.com/DanielHermosilla/ecological-inference-elections/blob/HEAD/vignettes/demonstration.Rmd" class="external-link"><code>vignettes/demonstration.Rmd</code></a></small>
      <div class="d-none name"><code>demonstration.Rmd</code></div>
    </div>

    
    
<p>The <code>fastei</code> library implements the
Expectation-Maximization algorithm to estimate probabilities in
non-parametric Ecological Inference for the RxC case. It offers both an
exact method and four approximation methods suitable for large datasets.
The application demonstrated here is based on an electoral context
where, for each ballot box, we know the number of voters in each
demographic group and the number of votes received by each
candidate.</p>
<div class="section level2">
<h2 id="estimate-voting-probabilities">Estimate Voting Probabilities<a class="anchor" aria-label="anchor" href="#estimate-voting-probabilities"></a>
</h2>
<p>We use data from the First Round of the Chilean Presidential Election
of 2021, where at each ballot box we have the voters of eight age ranges
(groups), and candidate votes obtained. The function
<code><a href="../reference/get_XW_chile.html">get_XW_chile()</a></code> loads this data at either the country,
region, or electoral district level.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://danielhermosilla.github.io/ecological-inference-elections/reference/fastei-package.html">fastei</a></span><span class="op">)</span></span>
<span></span>
<span><span class="va">apoquindo</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_XW_chile.html">get_XW_chile</a></span><span class="op">(</span>elect_district <span class="op">=</span> <span class="st">"APOQUINDO"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">apoquindo</span></span></code></pre></div>
<pre><code><span><span class="co">## eim ecological inference model</span></span>
<span><span class="co">## Candidates' vote matrix (X) [b x c]:</span></span>
<span><span class="co">##     C1  C2 C3 C4 C5 C6 C7 C8</span></span>
<span><span class="co">## 37M 36  91 19 48  2  7  2  5</span></span>
<span><span class="co">## 38M 29 103 17 54  1  6  3  3</span></span>
<span><span class="co">## 40M 25  95 21 38  3  4  2  2</span></span>
<span><span class="co">## 41M 31  86 19 48  0  4  5  2</span></span>
<span><span class="co">## 43M 28  76 16 66  1  2  0  1</span></span>
<span><span class="co">## .</span></span>
<span><span class="co">## .</span></span>
<span><span class="co">## .</span></span>
<span><span class="co">## Group-level voter matrix (W) [b x g]:</span></span>
<span><span class="co">##     X18.19 X20.29 X30.39 X40.49 X50.59 X60.69 X70.79 X80.</span></span>
<span><span class="co">## 37M      5     27     11     50     23     39     36   19</span></span>
<span><span class="co">## 38M      5     33     11     48     22     42     36   19</span></span>
<span><span class="co">## 40M      6     21      6     49     36     20     29   23</span></span>
<span><span class="co">## 41M      3     27      6     55     23     29     33   19</span></span>
<span><span class="co">## 43M      4     22      8     58     26     32     28   12</span></span>
<span><span class="co">## .</span></span>
<span><span class="co">## .</span></span>
<span><span class="co">## .</span></span></code></pre>
<p>As shown in the output, it returns an eim object that contains two
matrices: the number of votes per candidate and the number of votes per
group. The rows of both matrices correspond to the specific ballot-box,
and the columns are candidates and groups, respectively. This eim object
is used as input to run the EM algorithm that estimates the voting
probabilities. In this example, it uses the default method
<code>mult</code>, which is the most efficient in terms of runtime.
Running the algorithm is as simple as calling <code><a href="../reference/run_em.html">run_em()</a></code>. The
most efficient method tends to be “mult”:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">results</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_em.html">run_em</a></span><span class="op">(</span><span class="va">apoquindo</span><span class="op">)</span></span>
<span><span class="va">results</span><span class="op">$</span><span class="va">prob</span></span></code></pre></div>
<pre><code><span><span class="co">##                C1        C2         C3        C4           C5          C6</span></span>
<span><span class="co">## X18.19 0.18065151 0.3769887 0.08609561 0.3228505 0.0116633635 0.017520279</span></span>
<span><span class="co">## X20.29 0.20288189 0.3453684 0.04348590 0.3453619 0.0074515610 0.018659913</span></span>
<span><span class="co">## X30.39 0.16148597 0.4074162 0.04256031 0.3584222 0.0028040941 0.006642256</span></span>
<span><span class="co">## X40.49 0.09194612 0.4908708 0.07696848 0.3272220 0.0027235255 0.003147865</span></span>
<span><span class="co">## X50.59 0.15442068 0.4082031 0.09803601 0.2842914 0.0006296714 0.036160740</span></span>
<span><span class="co">## X60.69 0.09770731 0.5062656 0.09138068 0.2687257 0.0021351990 0.023742264</span></span>
<span><span class="co">## X70.79 0.10547464 0.5303769 0.08441581 0.2317909 0.0041415730 0.018717650</span></span>
<span><span class="co">## X80.   0.07254167 0.5065080 0.13750067 0.2327520 0.0099251090 0.022975509</span></span>
<span><span class="co">##                 C7           C8</span></span>
<span><span class="co">## X18.19 0.003981122 0.0002489339</span></span>
<span><span class="co">## X20.29 0.019823303 0.0169670846</span></span>
<span><span class="co">## X30.39 0.017852624 0.0028163233</span></span>
<span><span class="co">## X40.49 0.002094378 0.0050268188</span></span>
<span><span class="co">## X50.59 0.016133183 0.0021252418</span></span>
<span><span class="co">## X60.69 0.007540262 0.0025030014</span></span>
<span><span class="co">## X70.79 0.016452401 0.0086301151</span></span>
<span><span class="co">## X80.   0.007744594 0.0100524395</span></span></code></pre>
<p>Note that each row corresponds to the probability that a demographic
group (<code>g</code>) voted for a candidate (<code>c</code>). It is
worth noting how the results differ substantially across groups.</p>
</div>
<div class="section level2">
<h2 id="standard-deviation-estimates">Standard deviation estimates<a class="anchor" aria-label="anchor" href="#standard-deviation-estimates"></a>
</h2>
<p>We can compute the standard deviation of the estimated probabilities
using bootstrapping. This can be done with the function
<code><a href="../reference/bootstrap.html">bootstrap()</a></code>.</p>
<p><code>{r}We can compute the standard deviation of the estimated probabilities using bootstrapping. This can be done with the function bootstrap(). results &lt;- bootstrap(results, seed = 42, nboot = 30) results$sd</code></p>
<p>This output is expected, given that the number of ballot boxes in “EL
GOLF” is substantial. However, it can be insightful to analyze smaller
districts, such as “NAVIDAD”:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">navidad</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_XW_chile.html">get_XW_chile</a></span><span class="op">(</span>elect_district <span class="op">=</span> <span class="st">"NAVIDAD"</span><span class="op">)</span></span>
<span><span class="va">navidad</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/bootstrap.html">bootstrap</a></span><span class="op">(</span><span class="va">navidad</span>, seed <span class="op">=</span> <span class="fl">42</span>, nboot <span class="op">=</span> <span class="fl">30</span><span class="op">)</span></span>
<span><span class="va">navidad</span><span class="op">$</span><span class="va">sd</span></span></code></pre></div>
<pre><code><span><span class="co">##               C1        C2        C3        C4         C5        C6        C7</span></span>
<span><span class="co">## X18.19 0.3173885 0.2775066 0.1758247 0.3748034 0.34252173 0.1862111 0.2113297</span></span>
<span><span class="co">## X20.29 0.2642999 0.2148970 0.2300379 0.1921584 0.13142429 0.1357480 0.2093558</span></span>
<span><span class="co">## X30.39 0.1826393 0.2645530 0.1969771 0.1785584 0.10809154 0.1603991 0.1382038</span></span>
<span><span class="co">## X40.49 0.1742081 0.1950356 0.1933681 0.1778562 0.08903065 0.1302125 0.1298807</span></span>
<span><span class="co">## X50.59 0.1594534 0.1807864 0.2090455 0.1662446 0.06817806 0.1209976 0.1123312</span></span>
<span><span class="co">## X60.69 0.1560145 0.1709638 0.2038837 0.1540343 0.07426099 0.1352429 0.1038013</span></span>
<span><span class="co">## X70.79 0.1898688 0.1680642 0.2561830 0.1724892 0.07986201 0.1698474 0.1198108</span></span>
<span><span class="co">## X80.   0.2066339 0.1956702 0.2523605 0.1869649 0.09635772 0.1522668 0.1824570</span></span>
<span><span class="co">##                C8</span></span>
<span><span class="co">## X18.19 0.14267125</span></span>
<span><span class="co">## X20.29 0.06989264</span></span>
<span><span class="co">## X30.39 0.08648556</span></span>
<span><span class="co">## X40.49 0.08894098</span></span>
<span><span class="co">## X50.59 0.09715487</span></span>
<span><span class="co">## X60.69 0.06181052</span></span>
<span><span class="co">## X70.79 0.07333803</span></span>
<span><span class="co">## X80.   0.15758501</span></span></code></pre>
<p>In this case, the probability variations are noticeably more
significant, likely due to the smaller sample size.</p>
</div>
<div class="section level2">
<h2 id="reducing-variance-through-group-aggregation">Reducing Variance Through Group Aggregation<a class="anchor" aria-label="anchor" href="#reducing-variance-through-group-aggregation"></a>
</h2>
<p>Given the issue of high variability in smaller districts, an
interesting alternative is to merge some demographic groups while
maximizing the log-likelihood, subject to a standard deviation
constraint. One way to approach this is with a <em>“greedy”</em>
strategy, evaluating up to <span class="math inline">\(2^{G-1}\)</span>
group combinations.</p>
<p>To approximate such a solution, the package provides a heuristic:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">navidad_proxy</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_agg_proxy.html">get_agg_proxy</a></span><span class="op">(</span><span class="va">navidad</span>, seed <span class="op">=</span> <span class="fl">42</span>, sd_threshold <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span></span>
<span><span class="va">navidad_proxy</span><span class="op">$</span><span class="va">group_agg</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 2 3 4 5 6 7 8</span></span></code></pre>
<p>As shown in the output, the heuristic found a feasible configuration
by merging groups 1 with 2, 5 with 6, and 7 with 8. We can evaluate the
effectiveness of this grouping by comparing the mean standard deviation
to the original formulation:</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">navidad</span><span class="op">$</span><span class="va">sd</span><span class="op">)</span> <span class="op">-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="va">navidad_proxy</span><span class="op">$</span><span class="va">sd</span><span class="op">)</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.02969188</span></span></code></pre>
<p>The full greedy algorithm is also included in the package. In theory,
it explores a large number of combinations and may require substantial
computation time. However, using the “mult” method offers a fast and
efficient workaround:</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">navidad_opt</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_agg_opt.html">get_agg_opt</a></span><span class="op">(</span><span class="va">navidad</span>, seed <span class="op">=</span> <span class="fl">42</span>, sd_threshold <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span></span>
<span><span class="va">navidad_opt</span><span class="op">$</span><span class="va">group_agg</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 2 3 4 5 6 8</span></span></code></pre>
<p>Notably, the optimal group merging differs only slightly from the
heuristic result, suggesting that the approximation performs quite well
in this case.</p>
</div>
<div class="section level2">
<h2 id="comparing-results">Comparing results<a class="anchor" aria-label="anchor" href="#comparing-results"></a>
</h2>
<p>An usual use case comes among the question of how much could two
districts differ. For instance, we can compare the results of
“APOQUINDO” and “PROVIDENCIA”, two districts that usually yield similar
results:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">providencia</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_XW_chile.html">get_XW_chile</a></span><span class="op">(</span>elect_district <span class="op">=</span> <span class="st">"PROVIDENCIA"</span><span class="op">)</span></span>
<span></span>
<span><span class="va">comparison</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/welchtest.html">welchtest</a></span><span class="op">(</span></span>
<span>    X <span class="op">=</span> <span class="va">providencia</span><span class="op">$</span><span class="va">X</span>,</span>
<span>    W <span class="op">=</span> <span class="va">providencia</span><span class="op">$</span><span class="va">W</span>,</span>
<span>    X2 <span class="op">=</span> <span class="va">apoquindo</span><span class="op">$</span><span class="va">X</span>,</span>
<span>    W2 <span class="op">=</span> <span class="va">apoquindo</span><span class="op">$</span><span class="va">W</span>,</span>
<span>    method <span class="op">=</span> <span class="st">"mult"</span>,</span>
<span>    nboot <span class="op">=</span> <span class="fl">30</span>,</span>
<span>    seed <span class="op">=</span> <span class="fl">42</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="va">nonsignificant</span> <span class="op">&lt;-</span> <span class="va">comparison</span><span class="op">$</span><span class="va">pvals</span> <span class="op">&gt;=</span> <span class="fl">0.05</span></span>
<span><span class="va">nonsignificant</span></span></code></pre></div>
<pre><code><span><span class="co">##           C1    C2    C3    C4    C5   C6   C7   C8</span></span>
<span><span class="co">## X18.19 FALSE  TRUE  TRUE FALSE  TRUE TRUE TRUE TRUE</span></span>
<span><span class="co">## X20.29 FALSE FALSE  TRUE FALSE  TRUE TRUE TRUE TRUE</span></span>
<span><span class="co">## X30.39 FALSE FALSE FALSE FALSE  TRUE TRUE TRUE TRUE</span></span>
<span><span class="co">## X40.49 FALSE FALSE FALSE FALSE  TRUE TRUE TRUE TRUE</span></span>
<span><span class="co">## X50.59  TRUE FALSE FALSE FALSE FALSE TRUE TRUE TRUE</span></span>
<span><span class="co">## X60.69 FALSE FALSE  TRUE  TRUE  TRUE TRUE TRUE TRUE</span></span>
<span><span class="co">## X70.79  TRUE  TRUE  TRUE FALSE  TRUE TRUE TRUE TRUE</span></span>
<span><span class="co">## X80.    TRUE  TRUE FALSE FALSE  TRUE TRUE TRUE TRUE</span></span></code></pre>
<p>Hence, it can be seen that the group whom voting behaviour changes
the most is group 1, which is the youngest group. This is a common
pattern in Chilean elections, where younger voters tend to be more
volatile in their voting behaviour.</p>
</div>
<div class="section level2">
<h2 id="simulating-results">Simulating results<a class="anchor" aria-label="anchor" href="#simulating-results"></a>
</h2>
<p>In this section, we will examine each method using simulated
elections. The methods “mcmc” and “mvn_cdf” are particularly flexible,
supporting additional parameters.</p>
<p>We can generate samples using the function
<code><a href="../reference/simulate_election.html">simulate_election()</a></code>:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">samples</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/simulate_election.html">simulate_election</a></span><span class="op">(</span>num_groups <span class="op">=</span> <span class="fl">3</span>, num_candidates <span class="op">=</span> <span class="fl">3</span>, num_ballots <span class="op">=</span> <span class="fl">50</span>, seed <span class="op">=</span> <span class="fl">42</span><span class="op">)</span></span>
<span><span class="va">object</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/eim.html">eim</a></span><span class="op">(</span><span class="va">samples</span><span class="op">$</span><span class="va">X</span>, <span class="va">samples</span><span class="op">$</span><span class="va">W</span><span class="op">)</span></span></code></pre></div>
<p>All the methods attempt to approximate the probability of a group
voting for a candidate, given observed votes. Let <span class="math inline">\(X_{bgc}\)</span> represent the observed votes and
<span class="math inline">\(Y_{bgc}\)</span> represent the votes for
candidate <span class="math inline">\(c\)</span> from group <span class="math inline">\(g\)</span> in ballot box <span class="math inline">\(b\)</span>. Define <span class="math inline">\(q_{bgc} = \mathbb{P}(Y_{bgc}=1 \mid
X_{bgc})\)</span> as the probability of a specific group voting for a
candidate given the observed result. The methods aim to approximate:</p>
<p><span class="math display">\[q_{bgc}=\frac{P(\mathbf{X_b}=\mathbf{x_b}\;\vert\;Y_{bgc}=1)\cdot
p_{gc}}{\sum_{c'\in\mathcal{C}}P(\mathbf{X_b}=\mathbf{x_b}\;\vert\;Y_{bgc'}=1)\cdot
p_{gc'}}\]</span></p>
<div class="section level3">
<h3 id="multinomial">Multinomial<a class="anchor" aria-label="anchor" href="#multinomial"></a>
</h3>
<p>The multinomial method is the most efficient in practice,
approximating:</p>
<p><span class="math display">\[q\approx\frac{x_{bc}\cdot p_{gc}\cdot
r_{bgc}^{-1}}{\sum_{c'\in\mathcal{C}}x_{bc'}\cdot
p_{gc'}\cdot r_{bgc}^{-1}}\]</span></p>
<p>Where <span class="math display">\[r_{bgc}
:=\frac{\sum_{g'\in\mathcal{G}}w_{bg'}p_{g'c}-p_{gc}}{I_b-1}\]</span></p>
<p>This method has computational complexity <span class="math inline">\(O(B\cdot G\cdot C)\)</span>.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">multinomial</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_em.html">run_em</a></span><span class="op">(</span><span class="va">object</span>, method <span class="op">=</span> <span class="st">"mult"</span><span class="op">)</span></span>
<span><span class="va">multinomial_mae</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">multinomial</span><span class="op">$</span><span class="va">prob</span> <span class="op">-</span> <span class="va">samples</span><span class="op">$</span><span class="va">real_prob</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">multinomial_mae</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.01648889</span></span></code></pre>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">multinomial</span><span class="op">$</span><span class="va">time</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.000109</span></span></code></pre>
<p>This produces a Mean Absolute Error (MAE) of approximately <span class="math inline">\(1.64\%\)</span>.</p>
</div>
<div class="section level3">
<h3 id="multivariate-pdf">Multivariate PDF<a class="anchor" aria-label="anchor" href="#multivariate-pdf"></a>
</h3>
<p>It is not necessary to compute the full probability <span class="math inline">\(q_{bgc}\)</span>; instead, it can be approximated
by simplifying the integration over the hypercube <span class="math inline">\(\mathcal{A}\)</span> in both the numerator and
denominator:</p>
<p><span class="math display">\[q_{bgc}\approx\frac{\phi_{bgc}(x)\cdot
p_{gc}}{\sum_{c'\in\mathcal{C}}\phi_{bgc'}(x)\cdot
p_{gc}}\]</span></p>
<p>This method is also time-efficient</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">multivariate_pdf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_em.html">run_em</a></span><span class="op">(</span><span class="va">object</span>, method <span class="op">=</span> <span class="st">"mvn_pdf"</span><span class="op">)</span></span>
<span><span class="va">multivariate_pdf_mae</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">multivariate_pdf</span><span class="op">$</span><span class="va">prob</span> <span class="op">-</span> <span class="va">samples</span><span class="op">$</span><span class="va">real_prob</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">multivariate_pdf_mae</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.01540117</span></span></code></pre>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">multivariate_pdf</span><span class="op">$</span><span class="va">time</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.14378</span></span></code></pre>
<p>Provides an Mean Absolute Error (MAE) of approximately <span class="math inline">\(1.54\%\)</span>.</p>
</div>
<div class="section level3">
<h3 id="multivariate-cdf">Multivariate CDF<a class="anchor" aria-label="anchor" href="#multivariate-cdf"></a>
</h3>
<p>Aproximates the first and second moments of the <span class="math inline">\(q_{bgc}\)</span>. Since the approximation is
continuos, it defines an hypercube defined by:</p>
<p><span class="math display">\[\mathcal{A}_{bc}(\mathbf{x_b})=\prod^{C-1}_{c'=1}\left[x_{bc}-\frac{1}{2}-\mathbf{1}_{c'=c},
x_{bc}+\frac{1}{2}-\mathbf{1}_{c'=c_{c'=c}}\right]\]</span></p>
<p>Yielding the following approximation:</p>
<p><span class="math display">\[q_{bgc}\approx\frac{\int_{\mathcal{A}_{bc}(\mathbf{x}_b)}\phi_{bgc}(x)dx\cdot
p_{gc}}{\sum_{c'\in\mathcal{C}}\int_{\mathcal{A}_{bc'}}\phi_{bgc'}(x)dx\cdot
p_{gc'}}\]</span></p>
<p>Where <span class="math inline">\(\phi_{bgc}(\cdot)\)</span>
corresponds to the Multivariate Normal PDF.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">multivariate_cdf</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_em.html">run_em</a></span><span class="op">(</span><span class="va">object</span>, method <span class="op">=</span> <span class="st">"mvn_cdf"</span>, mc_error <span class="op">=</span> <span class="fl">1e-8</span><span class="op">)</span></span>
<span><span class="va">multivariate_cdf_mae</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">multivariate_cdf</span><span class="op">$</span><span class="va">prob</span> <span class="op">-</span> <span class="va">samples</span><span class="op">$</span><span class="va">real_prob</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">multivariate_cdf_mae</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.06268439</span></span></code></pre>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">multivariate_cdf</span><span class="op">$</span><span class="va">time</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.011881</span></span></code></pre>
<p>Providing a MAE of <span class="math inline">\(6.5\%\)</span>. Let’s
denote that, on average, it tends to be much smaller.</p>
</div>
<div class="section level3">
<h3 id="mcmc">MCMC<a class="anchor" aria-label="anchor" href="#mcmc"></a>
</h3>
<p>Since there are an exponential number of ways in which the samples
can be assigned, it is possible to use importance sampling (IS). Let
<span class="math inline">\(\mathcal{S}_b\)</span> be the set of
samples, then:</p>
<p><span class="math display">\[q_{bgc}\approx\frac{\sum_{\mathbf{z}_b\in\mathcal{S}_b}\frac{z_{bgc}}{w_{bg}}\prod_{g'\in\mathcal{G}}\left(\binom{w_{bg'}}{z_{bg'1},\dots,z_{bg'C}}\prod_{c'\in\mathcal{C}}p_{g'c'}^{z_{bg'c'}}\right)}{\sum_{\mathbf{z}_b\in\mathcal{S}_b}\prod_{g'\in\mathcal{G}}\left(\binom{w_{bg'}}{z_{bg'1},\dots,z_{bg'C}}\prod_{c'\in\mathcal{C}}p_{g'c'}^{z_{bg'c'}}\right)}\]</span></p>
<p>Hence, it is possible to approximate the posterior by running as
following:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mcmc</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_em.html">run_em</a></span><span class="op">(</span><span class="va">object</span>, method <span class="op">=</span> <span class="st">"mcmc"</span>, samples <span class="op">=</span> <span class="fl">1000</span>, step_size <span class="op">=</span> <span class="fl">3000</span>, seed <span class="op">=</span> <span class="fl">42</span><span class="op">)</span></span>
<span><span class="va">mcmc_mae</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">mcmc</span><span class="op">$</span><span class="va">prob</span> <span class="op">-</span> <span class="va">samples</span><span class="op">$</span><span class="va">real_prob</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">mcmc_mae</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.008539851</span></span></code></pre>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mcmc</span><span class="op">$</span><span class="va">time</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 2.066849</span></span></code></pre>
<p>Having a MAE of <span class="math inline">\(0.8\%\)</span>, with a
running time of <span class="math inline">\(2.58826\)</span> seconds.
This method is the most flexible, as it allows for the inclusion of
additional parameters. However, it is also one of the slowest, as it
requires a large number of samples to achieve a good approximation.</p>
</div>
<div class="section level3">
<h3 id="exact">Exact<a class="anchor" aria-label="anchor" href="#exact"></a>
</h3>
<p>Provides the full calculation, using the Law of Total
Probabilities:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">exact</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/run_em.html">run_em</a></span><span class="op">(</span><span class="va">object</span>, method <span class="op">=</span> <span class="st">"exact"</span><span class="op">)</span></span>
<span><span class="va">exact_mae</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html" class="external-link">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">exact</span><span class="op">$</span><span class="va">prob</span> <span class="op">-</span> <span class="va">samples</span><span class="op">$</span><span class="va">real_prob</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">exact_mae</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 0.01642448</span></span></code></pre>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">exact</span><span class="op">$</span><span class="va">time</span></span></code></pre></div>
<pre><code><span><span class="co">## [1] 22.01659</span></span></code></pre>
<p>Providing a MAE of <span class="math inline">\(1.6\%\)</span> with
the longest running time.</p>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>fastei</p>
</div>

<div class="pkgdown-footer-right">
  <p>Developed by Daniel Hermosilla.</p>
</div>

    </footer>
</div>





  </body>
</html>
