---
title: "Demonstration of the package usage"
author: "Daniel Hermosilla"
date: "`r Sys.Date()`"

vignette: >
  %\VignetteIndexEntry{Demonstration of the package usage}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}

output:
  rmarkdown::html_vignette:
    toc: false
    number_sections: false
---

The Expectation-Maximization algorithm is a statistical framework that relies on maximizing the log-likelihood of a conditional probability distribution. This algorithm depends on the heterogeneity of the sample and, as with every statistical method, it becomes more efficient as the sample size increases.

# Running the Expectation-Maximization algorithm 
One of the most meaningful use cases relies on political elections. As of this package, it provides the dataset with the Chilean Presidential Election from 2021. Such results are divided among electoral districts, where it's known the ages from each voter. 

To set up the algorithm, you can load a sample using `get_XW_chile()`:

```{r}
library(fastei)

el_golf <- get_XW_chile(elect_district = "EL GOLF")

el_golf
```

As shown in the output, it returns an eim object that contains two matrices: the number of votes per candidate and the number of votes per group.

Running the algorithm is as simple as calling `run_em()`. The most efficient method tends to be "mult":

```{r}
results <- run_em(el_golf)
results$prob
```

Note that each row corresponds to the probability that a demographic group (g) voted for a candidate (c). It is worth noting how the results differ substantially across groups.

# Getting standard deviation estimates

Itâ€™s important to note that the initial estimates may not always be efficient in terms of their standard deviation. Fortunately, the package provides a `bootstrap()` function that allows you to estimate the variability of the results:
```{r}
results <- bootstrap(results, seed = 42, nboot = 30)
results$sd
```

This output is expected, given that the number of ballot boxes in "EL GOLF" is substantial. However, it can be insightful to analyze smaller districts, such as "NAVIDAD":

```{r}
navidad <- get_XW_chile(elect_district = "NAVIDAD")
navidad <- bootstrap(navidad, seed = 42, nboot = 30)
navidad$sd
```

In this case, the probability variations are noticeably more significant, likely due to the smaller sample size.

# Reducing Variance Through Group Aggregation

Given the issue of high variability in smaller districts, an interesting alternative is to merge some demographic groups while maximizing the log-likelihood, subject to a standard deviation constraint. One way to approach this is with a *"greedy"* strategy, evaluating up to $2^{G-1}$ group combinations.

To approximate such a solution, the package provides a heuristic:

```{r}
navidad_proxy <- get_agg_proxy(navidad, seed = 42)
navidad_proxy$group_agg
```

As shown in the output, the heuristic found a feasible configuration by merging groups 1 with 2, 5 with 6, and 7 with 8. We can evaluate the effectiveness of this grouping by comparing the mean standard deviation to the original formulation:

```{r}
mean(navidad$sd) - mean(navidad_proxy$sd)
```

The full greedy algorithm is also included in the package. In theory, it explores a large number of combinations and may require substantial computation time. However, using the "mult" method offers a fast and efficient workaround:

```{r}
navidad_opt <- get_agg_opt(navidad, seed = 42)
navidad_opt$group_agg
```

Notably, the optimal group merging differs only slightly from the heuristic result, suggesting that the approximation performs quite well in this case.

# Comparing results

An usual use case comes among the question of how much could two districts differ. For instance, we can compare the results of "LO BARNECHEA" and "EL GOLF", two districts that usually yield similar results:

```{r}
apoquindo <- get_XW_chile(elect_district = "APOQUINDO")

comparison <- welchtest(
    X = el_golf$X,
    W = el_golf$W,
    X2 = apoquindo$X,
    W2 = apoquindo$W,
    method = "mult",
    nboot = 30,
    seed = 42
)

nonsignificant <- comparison$pvals >= 0.05
```

Hence, it can be seen that the group whom voting behaviour changes the most is group 1, which is the youngest group. This is a common pattern in Chilean elections, where younger voters tend to be more volatile in their voting behaviour.
