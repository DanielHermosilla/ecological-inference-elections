<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Runs the EM algorithm aggregating adjacent groups, maximizing the variability of macro-group allocation in ballot boxes. — get_agg_proxy • fastei</title><!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js" integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous"><script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css"><script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous"><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous"><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet"><script src="../pkgdown.js"></script><meta property="og:title" content="Runs the EM algorithm aggregating adjacent groups, maximizing the variability of macro-group allocation in ballot boxes. — get_agg_proxy"><meta property="og:description" content="This function estimates the voting probabilities (computed using run_em) aggregating adjacent groups so that the estimated probabilities' standard deviation (computed using bootstrap) is below a given threshold. See Details for more information."><!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--></head><body data-spy="scroll" data-target="#toc">


    <div class="container template-reference-topic">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">fastei</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="">0.0.0.1</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav"><li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Articles

    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu"><li>
      <a href="../articles/demonstration.html">Quick demo</a>
    </li>
  </ul></li>
      </ul><ul class="nav navbar-nav navbar-right"><li>
  <a href="https://github.com/DanielHermosilla/ecological-inference-elections/" class="external-link">
    <span class="fab fa-github fa-lg"></span>

  </a>
</li>
      </ul></div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->



      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header">
    <h1>Runs the EM algorithm aggregating adjacent groups, maximizing the variability of macro-group allocation in ballot boxes.</h1>
    <small class="dont-index">Source: <a href="https://github.com/DanielHermosilla/ecological-inference-elections/blob/HEAD/R/eim-class.R" class="external-link"><code>R/eim-class.R</code></a></small>
    <div class="hidden name"><code>get_agg_proxy.Rd</code></div>
    </div>

    <div class="ref-description">
    <p>This function estimates the voting probabilities (computed using <a href="run_em.html">run_em</a>) aggregating adjacent groups so that the estimated probabilities' standard deviation (computed using <a href="bootstrap.html">bootstrap</a>) is below a given threshold. See <strong>Details</strong> for more information.</p>
    </div>

    <div id="ref-usage">
    <div class="sourceCode"><pre class="sourceCode r"><code><span><span class="fu">get_agg_proxy</span><span class="op">(</span></span>
<span>  object <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  X <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  W <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  json_path <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  sd_statistic <span class="op">=</span> <span class="st">"maximum"</span>,</span>
<span>  sd_threshold <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>  feasible <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  nboot <span class="op">=</span> <span class="fl">50</span>,</span>
<span>  seed <span class="op">=</span> <span class="cn">NULL</span>,</span>
<span>  <span class="va">...</span></span>
<span><span class="op">)</span></span></code></pre></div>
    </div>

    <div id="arguments">
    <h2>Arguments</h2>


<dl><dt id="arg-object">object<a class="anchor" aria-label="anchor" href="#arg-object"></a></dt>
<dd><p>An object of class <code>eim</code>, which can be created using the eim function. This parameter should not be used if either (i) <code>X</code> and <code>W</code> matrices or (ii) <code>json_path</code> is supplied. See <strong>Note</strong> in <a href="run_em.html">run_em</a>.</p></dd>


<dt id="arg-x">X<a class="anchor" aria-label="anchor" href="#arg-x"></a></dt>
<dd><p>A <code>(b x c)</code> matrix representing candidate votes per ballot box.</p></dd>


<dt id="arg-w">W<a class="anchor" aria-label="anchor" href="#arg-w"></a></dt>
<dd><p>A <code>(b x g)</code> matrix representing group votes per ballot box.</p></dd>


<dt id="arg-json-path">json_path<a class="anchor" aria-label="anchor" href="#arg-json-path"></a></dt>
<dd><p>A path to a JSON file containing <code>X</code> and <code>W</code> fields, stored as nested arrays. It may contain additional fields with other attributes, which will be added to the returned object.</p></dd>


<dt id="arg-sd-statistic">sd_statistic<a class="anchor" aria-label="anchor" href="#arg-sd-statistic"></a></dt>
<dd><p>String indicates the statistic for the standard deviation <code>(g x c)</code> matrix for the stopping condition, i.e., the algorithm stops when the statistic is below the threshold. It can take the value <code>maximum</code>, in which case computes the maximum over the standard deviation matrix, or <code>average</code>, in which case computes the average.</p></dd>


<dt id="arg-sd-threshold">sd_threshold<a class="anchor" aria-label="anchor" href="#arg-sd-threshold"></a></dt>
<dd><p>Numeric with the value to use as a threshold for the statistic (<code>sc_statistic</code>) of the standard deviation of the estimated probabilities. Defaults to 0.05.</p></dd>


<dt id="arg-feasible">feasible<a class="anchor" aria-label="anchor" href="#arg-feasible"></a></dt>
<dd><p>Logical indicating whether the returned matrix must strictly satisfy the <code>sd_threshold</code>.
If FALSE, the function will return the closest match to the threshold in case convergence is not achieved.</p></dd>


<dt id="arg-nboot">nboot<a class="anchor" aria-label="anchor" href="#arg-nboot"></a></dt>
<dd><p>Integer specifying how many times to run the
EM algorithm.</p></dd>


<dt id="arg-seed">seed<a class="anchor" aria-label="anchor" href="#arg-seed"></a></dt>
<dd><p>If provided, overrides the current global seed. Defaults to <code>NULL</code>.</p></dd>


<dt id="arg--">...<a class="anchor" aria-label="anchor" href="#arg--"></a></dt>
<dd><p>Additional arguments passed to the <a href="run_em.html">run_em</a> function that will execute the EM algorithm.</p></dd>

</dl></div>
    <div id="value">
    <h2>Value</h2>
    <p>It returns an eim object with the same attributes as the output of <a href="run_em.html">run_em</a>, plus the attributes:</p><ul><li><p><strong>sd</strong>: A <code>(g x a)</code> matrix with the standard deviation of the estimated probabilities computed with bootstrapping. Note that <code>a</code> denotes the number of macro-groups of the resulting group aggregation, it should be between <code>2</code> and <code>g</code>.</p></li>
<li><p><strong>sd_statistic</strong>: The statistic used as input.</p></li>
<li><p><strong>sd_threshold</strong>: The threshold used as input.</p></li>
<li><p><strong>group_agg</strong>: Vector with the resulting group aggregation. See <strong>Examples</strong> for more details.</p></li>
</ul><p>Aditionally, it will create the <code>W_agg</code> attribute with the aggregated groups.</p>
    </div>
    <div id="details">
    <h2>Details</h2>
    <p>Groups need to have an order relation so that adjacent groups can be merged. For example, consider the following seven groups defined by voters' age ranges: 20-29, 30-39, 40-49, 50-59, 60-69, 70-79, and 80+. A possible group aggregation can be a macro-group composed of the three following age ranges: 20-39, 40-59, and 60+. Since there are multiple group aggregations, even for a fixed number of macro-groups, a Dynamic Program (DP) mechanism is used to find the group aggregation that maximizes the sum of the standard deviation of the macro-groups proportions among ballot boxes for a specific number of macro-groups.</p>
<p>In order to find the best group aggregation, the function runs the DP iteratively, starting with all groups (this case is trivial since, in this case, the group aggregation is such that all macro-groups match exactly the original groups). If the standard deviation statistic is below a threshold, it stops. Otherwise, it runs the DP such that the number of macro-groups is one unit less than the original number of macro-groups. If the standard deviation statistic (<code>sd_statistic</code>) is below the threshold (<code>sd_threshold</code>), it stops. And so on until either the algorithm stops, or until the group aggregation composed of a single macro-group does not meet the stopping condition, in which case the output is the EM algorithm run over a single macro-group.</p>
    </div>
    <div id="see-also">
    <h2>See also</h2>
    <div class="dont-index"><p>The eim object and <a href="run_em.html">run_em</a> implementation.</p></div>
    </div>

    <div id="ref-examples">
    <h2>Examples</h2>
    <div class="sourceCode"><pre class="sourceCode r"><code><span class="r-in"><span><span class="co"># Example 1: Using a simulated instance</span></span></span>
<span class="r-in"><span><span class="va">simulations</span> <span class="op">&lt;-</span> <span class="fu"><a href="simulate_election.html">simulate_election</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>    num_ballots <span class="op">=</span> <span class="fl">400</span>,</span></span>
<span class="r-in"><span>    num_candidates <span class="op">=</span> <span class="fl">3</span>,</span></span>
<span class="r-in"><span>    num_groups <span class="op">=</span> <span class="fl">6</span>,</span></span>
<span class="r-in"><span>    group_proportions <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0.4</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.1</span>, <span class="fl">0.2</span>, <span class="fl">0.1</span><span class="op">)</span>,</span></span>
<span class="r-in"><span>    lambda <span class="op">=</span> <span class="fl">0.7</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">result</span> <span class="op">&lt;-</span> <span class="fu">get_agg_proxy</span><span class="op">(</span></span></span>
<span class="r-in"><span>    X <span class="op">=</span> <span class="va">simulations</span><span class="op">$</span><span class="va">X</span>,</span></span>
<span class="r-in"><span>    W <span class="op">=</span> <span class="va">simulations</span><span class="op">$</span><span class="va">W</span>,</span></span>
<span class="r-in"><span>    sd_threshold <span class="op">=</span> <span class="fl">0.01</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">result</span><span class="op">$</span><span class="va">group_agg</span> <span class="co"># c(2, 6)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] 1</span>
<span class="r-in"><span><span class="co"># This would mean that the ideal group aggregation would</span></span></span>
<span class="r-in"><span><span class="co"># be {[1, 2], [3, 6]}</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Example 2: Using the chilean election results</span></span></span>
<span class="r-in"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">chile_election_2021</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">niebla_df</span> <span class="op">&lt;-</span> <span class="va">chile_election_2021</span><span class="op">[</span><span class="va">chile_election_2021</span><span class="op">$</span><span class="va">ELECTORAL.DISTRICT</span> <span class="op">==</span> <span class="st">"NIEBLA"</span>, <span class="op">]</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Create the X matrix with selected columns</span></span></span>
<span class="r-in"><span><span class="va">X</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">niebla_df</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"C1"</span>, <span class="st">"C2"</span>, <span class="st">"C3"</span>, <span class="st">"C4"</span>, <span class="st">"C5"</span>, <span class="st">"C6"</span>, <span class="st">"C7"</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="co"># Create the W matrix with selected columns</span></span></span>
<span class="r-in"><span><span class="va">W</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">as.matrix</a></span><span class="op">(</span><span class="va">niebla_df</span><span class="op">[</span>, <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span></span></span>
<span class="r-in"><span>    <span class="st">"X18.19"</span>, <span class="st">"X20.29"</span>,</span></span>
<span class="r-in"><span>    <span class="st">"X30.39"</span>, <span class="st">"X40.49"</span>,</span></span>
<span class="r-in"><span>    <span class="st">"X50.59"</span>, <span class="st">"X60.69"</span>,</span></span>
<span class="r-in"><span>    <span class="st">"X70.79"</span>, <span class="st">"X80."</span></span></span>
<span class="r-in"><span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">solution</span> <span class="op">&lt;-</span> <span class="fu">get_agg_proxy</span><span class="op">(</span></span></span>
<span class="r-in"><span>    X <span class="op">=</span> <span class="va">X</span>, W <span class="op">=</span> <span class="va">W</span>,</span></span>
<span class="r-in"><span>    allow_mismatch <span class="op">=</span> <span class="cn">TRUE</span>, sd_threshold <span class="op">=</span> <span class="fl">0.03</span>,</span></span>
<span class="r-in"><span>    sd_statistic <span class="op">=</span> <span class="st">"average"</span>, nboot <span class="op">=</span> <span class="fl">100</span></span></span>
<span class="r-in"><span><span class="op">)</span></span></span>
<span class="r-in"><span></span></span>
<span class="r-in"><span><span class="va">solution</span><span class="op">$</span><span class="va">group_agg</span> <span class="co"># c(3, 4, 5, 6, 7)</span></span></span>
<span class="r-out co"><span class="r-pr">#&gt;</span> [1] 3 4 5 6</span>
<span class="r-in"><span><span class="co"># This would mean that the ideal group aggregation would</span></span></span>
<span class="r-in"><span><span class="co"># be {[1, 3], [4], [5], [6], [7, 8]}</span></span></span>
<span class="r-in"><span></span></span>
</code></pre></div>
    </div>
  </div>
  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">
    <nav id="toc" data-toggle="toc" class="sticky-top"><h2 data-toc-skip>Contents</h2>
    </nav></div>
</div>


      <footer><div class="copyright">
  <p></p><p>Developed by Daniel Hermosilla.</p>
</div>

<div class="pkgdown">
  <p></p><p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.1.</p>
</div>

      </footer></div>






  </body></html>

